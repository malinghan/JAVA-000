# 1
## 题目要求
 列举常见的分布式事务,简单分析其使用场景和优缺点
## 解题报告

常见的分布式事务协议有,XA,TCC,TAC(AT)、Saga事务

### XA
XA 协议在架构上与 TCC 模型相比，最大的不同是 XA 直接作用于资源层，而后者作用于服务层。

资源层更普适，并且对业务几乎没有侵入，但为了适应各种业务场景使用，需要严格遵循事务 ACID 特性；服务层更接近业务，可以针对不同业务做特定的优化处理，追求更高的极限性能。

当然，并不是说 XA 协议只能作用于单个服务内部的多资源场景，跨服务的多资源场景也是可以的，只不过同样需要额外的事务传递机制。

XA 协议通过每个 RM（Resource Manager，资源管理器）的本地事务隔离性来保证全局隔离，并且需要通过串行化隔离级别来保证分布式事务一致性。但是，串行化隔离级别存在一定的性能问题。

**场景**:
- 直接作用于资源层,对业务几乎没有侵入，适合对一致性要求较高的服务,适合单个服务内部的多资源(多数据源)场景
  
**优点**:

- 严格遵循事务 ACID 特性，服务层更接近业务；
- 数据库资源横向扩展时，能保证多资源访问的事务属性；
- 可以让开发者从底层技术细节中脱离出来，更专注于业务逻辑的实现，从而获得更高效、快速的业务发展；
 
**缺点**: 

- 需要通过串行化隔离级别来保证分布式事务一致性，但是，串行化隔离级别存在一定的性能问题
    
### TCC
TCC 分布式事务模型直接作用于服务层,不与具体的服务框架耦合，与底层 RPC 协议无关，与底层存储介质无关，可以灵活选择业务资源的锁定粒度，减少资源锁持有时间，可扩展性好，可以说是为独立部署的 SOA 服务而设计的。

**最佳实践**

➢业务模型分2阶段设计

➢并发控制

➢允许空回滚

➢防悬挂控制

➢幂等控制

**场景**
- 通用型 TCC 分布式事务解决方案适用于执行时间确定且较短的业务，比如互联网金融企业最核心的三个服务：交易、支付、账务
- 补偿型 TCC 分布式事务解决方案只适用于一些并发冲突较少或者需要与外部交互的业务，这些外部业务不属于被动型业务，其执行结果会影响主业务服务的决策，比如机票代理商的机票预订服务
- 异步确保性 TCC 分布式事务解决方案只适用于对最终一致性时间敏感度较低的一些被动型业务（从业务服务的处理结果不影响主业务服务的决策，只被动的接收主业务服务的决策结果）。比如会员注册服务和邮件发送服务
**优点**
- 解决热点数据并发性能问题
**缺点**
- 柔性事务,无法做到强一致性
- 侵入性比XA高

### AT

AT 模式如何做到对业务的无侵入 ：

#### 一阶段：
在一阶段，Seata 会拦截“业务 SQL”，首先解析 SQL 语义，找到“业务 SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”，然后执行“业务 SQL”更新业务数据，在业务数据更新之后，再将其保存成“after image”，最后生成行锁。以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。

#### 二阶段提交：
二阶段如果是提交的话，因为“业务 SQL”在一阶段已经提交至数据库， 所以 Seata 框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。

#### 二阶段回滚：
二阶段如果是回滚的话，Seata 就需要回滚一阶段已经执行的“业务 SQL”，还原业务数据。回滚方式便是用“before image”还原业务数据；但在还原前要首先要校验脏写，对比“数据库当前业务数据”和 “after image”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。

AT 模式的一阶段、二阶段提交和回滚均由 Seata 框架自动生成，用户只需编写“业务 SQL”，便能轻松接入分布式事务，AT 模式是一种对业务无任何侵入的分布式事务解决方案。

**场景**
和TCC类型
**优点**
- AT模式对业务代码无侵入
**缺点**
- rollback的sql容易出问题

### Saga模式

**场景**

Saga 模式适用于业务流程长且需要保证事务最终一致性的业务系统，Saga 模式一阶段就会提交本地事务，无锁、长流程情况下可以保证性能。

事务参与者可能是其它公司的服务或者是遗留系统的服务，无法进行改造和提供 TCC 要求的接口，可以使用 Saga 模式。

**优点**

- 一阶段提交本地数据库事务，无锁，高性能；
- 参与者可以采用事务驱动异步执行，高吞吐；
- 补偿服务即正向服务的“反向”，易于理解，易于实现；

**缺点**

缺点：Saga 模式由于一阶段已经提交本地数据库事务，且没有进行“预留”动作，所以不能保证隔离性。后续会讲到对于缺乏隔离性的应对措施。

与TCC实践经验相同的是，Saga 模式中，每个事务参与者的冲正、逆向操作，需要支持：

- 空补偿：逆向操作早于正向操作时；
- 防悬挂控制：空补偿后要拒绝正向操作
- 幂等

### 参考
- [分布式事务主流解决方案优缺点大pk](https://dbaplus.cn/news-159-1929-1.html)
- [分布式事务的4种模式](https://zhuanlan.zhihu.com/p/78599954)


# 2
## 题目要求
## 解题报告
# 3
## 题目要求
## 解题报告
# 4
## 题目要求
## 解题报告
# 5
## 题目要求
## 解题报告
# 6
## 题目要求
## 解题报告
# 7
## 题目要求
## 解题报告